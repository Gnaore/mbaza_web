<p-toast></p-toast>

<!--button *ngIf=" afficherFormulaire == false && nbreDispo != 0 " (click)="TogglAfficheFormulaire()">Affiche
    Formulaire</button>
<button *ngIf=" afficherFormulaire == true" (click)="TogglAfficheFormulaire()">Cacher Formulaire</button-->

<div class="card" *ngIf=" afficherFormulaire == true ">
    <div class="card-header text-uppercase text-primary fw-bold">
        Formulaire d'enregistrement d'un locataire
    </div>

    <div class="card-body">
        <form class="row" [formGroup]="formGroup">
            <input type="text" formControlName="locataireId" placeholder="locataireId" hidden />
            <input type="text" formControlName="bailleurId" placeholder="bailleurId" hidden />
            <input type="text" formControlName="locataireRef" placeholder="locataireRef" hidden />

            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <select class="form-select-lg form-select rounded-0" (change)="onChangePropriete($event)"
                    formControlName="proprieteCode">
                    <option value="">CODE PROPRIETE</option>
                    <option value="{{propriete.proprieteCode}}" *ngFor="let propriete of listProprietes"
                        title="{{propriete.typebien.libelleTypebien}} - {{propriete.proprietePrix}} ">
                        {{propriete.proprieteCode}}</option>

                </select>

            </div>
            <div class="review-form col-lg-4 col-md-5 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Localisation" readonly [(ngModel)]="localisation"
                    formControlName="localisation">
            </div>
            <div class="review-form col-lg-3 col-md-2 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Type" readonly [(ngModel)]="type"
                    formControlName="type">
            </div>
            <div class="review-form col-lg-2 col-md-2 col-sm-12 col-12">
                <input type="number" class="form-control" readonly [(ngModel)]="prix" formControlName="prix">
            </div>

            <div class="hcenter" *ngIf="qrcode!=''">
                <!--img src="{{urlimg}}" width="100px"-->
                <div class="qrcodeImage" style="text-align: center;">
                    <qrcode #parent [qrdata]="qrcode" [allowEmptyString]='false' [elementType]="'img'"
                        [errorCorrectionLevel]="'M'" [width]="100" [margin]="4" [scale]="1"
                        (qrCodeURL)="onChangeURL($event, parent)"></qrcode>
                </div>
            </div>


            <hr style="margin-top: 0px;" />
            <div class="review-form col-lg-6 col-md-6 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Nom & Prénom(s)" formControlName="locataireNom">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="date" class="form-control" placeholder="Date de naissance"
                    formControlName="locataireDatenais">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <select class="form-select-lg form-select rounded-0" formControlName="locataireNationalite">
                    <option value="">Nationalité</option>
                    <option value="Ivoirienne">Ivoirienne</option>
                    <option value="Camerounaise">Camerounaise</option>
                </select>
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Téléphone" formControlName="locataireTel">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Email" formControlName="locataireEmail">
            </div>

            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <select class="form-select-lg form-select rounded-0" formControlName="locataireSituationmatri">
                    <option value="">S. Matrimoniale</option>
                    <option value="Célibataire">Célibataire</option>
                    <option value="Mariée">Mariée</option>
                    <option value="Veuve">Veuve</option>
                    <option value="Divorcée">Divorcée</option>
                </select>
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="number" class="form-control" placeholder="Nombre de personnes à charge"
                    formControlName="locataireNbrecharge">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <select class="form-select-lg form-select rounded-0" formControlName="locataireTypecontrat">
                    <option value="">Type de contrat</option>
                    <option value="Indépendant">Indépendant</option>
                    <option value="CDD">CDD</option>
                    <option value="CDI">CDI</option>
                </select>
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Profession" formControlName="locataireProfession">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Salaire mensuel net"
                    formControlName="locataireSalaire">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Email du gestionnaire"
                    formControlName="locataireBanque">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Nom de votre garant"
                    formControlName="locataireNomgarant">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="text" class="form-control" placeholder="Téléphone de votre garant"
                    formControlName="locataireTelgarant">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="email" class="form-control" placeholder="Email de votre garant"
                    formControlName="locataireEmailgarant">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <input type="number" class="form-control" placeholder="Caution " formControlName="locataireCaution">
            </div>
            <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                <div class="col-6 input-group mb-3">
                    <div class="input-group-text">
                        <label style="cursor: pointer" for="file"><i class="ti ti-upload"></i> Photo
                            <span class="text-danger">*</span></label>
                        <input type="file" accept="image/png, image/jpeg" id="file"
                            class="form-control form-control-lg rounded-0 d-none" (change)="onFileChange($event)" />
                    </div>
                    <input type="text" class="form-control" readonly [value]="previewImage ? previewImage : ''"
                        placeholder="Aucun fichier sélectionné" />
                    <div class="col-12" style="text-align: center">
                        <img *ngIf="lienPhotoretour" src="{{ lienPhotoretour }}" alt="" width="100" height="100"
                            class="rounded-circle" />
                    </div>
                </div>
            </div>
            <div class="review-form col-12 d-flex align-items-center justify-content-center">
                <button class="btn-secondary me-3" (click)="onAnnuler()">
                    Annuler
                </button>
                <button type="button" class="btn-primary" (click)="submitLocataire(formGroup.value)"
                    [disabled]="formGroup.invalid">
                    Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<!--------------------------------------------------------------------->

<p-table #dt2 [value]="listLocataire" [rows]="10" [showCurrentPageReport]="true"
    [globalFilterFields]="['locataireRef','locataireNom','propriete.proprieteCode','propriete.proprietePrix','locataireTel','locataireEmail']"
    [rowsPerPageOptions]="[10,20,50]" [loading]="isLoading" [paginator]="true" selectionMode="multiple"
    [(selection)]="selectedLocataire" [rowHover]="true" dataKey="locataireId"
    currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} éléments">

    <ng-template pTemplate="caption">
        <div class="flex align-items-center justify-content-between">
            <p-confirmDialog></p-confirmDialog>
            <!--button class="btn btn-primary me-2 mb-2 mt-2" [disabled]="!selectedLocataire || !selectedLocataire.length"
                (click)="confirm1($event)">
                <i class="fa fa-bell me-2"></i>
                Alerte Huissier
            </button-->
            <span class="p-input-icon-left">
                <i class="pi pi-search"></i>
                <input pInputText type="text" (input)="dt2.filterGlobal($any($event.target).value, 'contains')"
                    placeholder="Recherche rapide..." />
            </span>
        </div>
    </ng-template>

    <ng-template pTemplate="header">
        <tr>
            <th style="width: 3rem">
                <p-tableHeaderCheckbox (click)="selectRow()" #e></p-tableHeaderCheckbox>
            </th>
            <th pSortableColumn="locataireRef">Réf. <p-sortIcon field="locataireRef"></p-sortIcon></th>
            <th>Photo.</th>
            <th pSortableColumn="locataireNom">Nom & Prénom(s) <p-sortIcon field="locataireNom"></p-sortIcon></th>
            <th pSortableColumn="propriete.proprieteCode">Code Propriete <p-sortIcon
                    field="propriete.proprieteCode"></p-sortIcon></th>
            <th pSortableColumn="propriete.proprietePrix">Prix <p-sortIcon field="propriete.proprietePrix"></p-sortIcon>
            </th>
            <th pSortableColumn="locataireTel">Téléphone <p-sortIcon field="locataireTel"></p-sortIcon></th>
            <th pSortableColumn="locataireEmail">E-mail <p-sortIcon field="locataireEmail"></p-sortIcon></th>
            <th>Actions</th>
        </tr>
    </ng-template>
    <ng-template pTemplate="body" let-loc>
        <tr>
            <td>
                <!--p-checkbox [binary]="true" inputId={{loc.id}}></p-checkbox-->
                <p-tableCheckbox (click)="selectRow()" [value]="loc"></p-tableCheckbox>
            </td>
            <td>
                {{loc.locataireRef}}
            </td>
            <td>
                <div style="width: 50px; height: 50px;" *ngIf="loc.locatairePhoto">
                    <img src="{{urlgimg + loc.locatairePhoto}}" alt="" class="w-100 h-100">
                </div>
                <div style="width: 50px; height: 50px;" *ngIf="!loc.locatairePhoto">
                    <img src="{{urlphotoDefault}}" alt="" class="w-100 h-100">
                </div>
            </td>
            <td>
                <span class="image-text">{{loc.locataireNom}}</span>
            </td>
            <td>
                {{loc.propriete.proprieteCode }}
            </td>
            <td>
                {{loc.propriete.proprietePrix}} FCFA
            </td>
            <td>
                <span class="image-text">{{loc.locataireTel}}</span>
            </td>
            <td>
                <span class="image-text">{{loc.locataireEmail}}</span>
            </td>
            <td>
                <div class="d-flex">
                    <button class="btn btn-primary me-2" title="Edition" (click)="oneLocataireByRef(loc.locataireRef)">
                        <i class="fa fa-edit"></i>
                    </button>

                    <button class="btn btn-lightred  me-2" title="Suivi paiements"
                        (click)="detailsPaiement(loc.locataireRef,loc.locataireNom,loc.locataireTel,loc.locataireEmail, loc.locatairePhoto,loc.propriete.proprietePrix)">
                        <i class="fa fa-search"></i>
                    </button>

                    <!--button class="btn btn-danger  me-2" title="Fin de contrat"
                        (click)="fincontrat(loc.locataireRef,loc.propriete.proprieteCode,loc.locataireEmail)">
                        <i class="fa fa-hourglass-end"></i>
                    </button-->

                </div>
            </td>

        </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
        <tr>
            <td colspan="7">Aucun enregistrement </td>
        </tr>
    </ng-template>
</p-table>
<!--------------------------------------------------------------------------->


<p-dialog [(visible)]="detailsPaiementDialog" [style]="{width: '80%'}" header="Suivi du Locatire :  {{vlocataireRef}} "
    [modal]="true" styleClass="p-fluid" [maximizable]="true" [baseZIndex]="10000" [draggable]="false"
    [resizable]="false">


    <ng-template pTemplate="content">
        <div class="card">
            <div class="row mb-2">
                <div class="col-md-8">
                    <h5 style="color: blueviolet;">{{vlocataireNom}}</h5>
                    <a> <strong style="color: blueviolet;">Email: </strong> {{vlocataireEmail}} | <strong
                            style="color: blueviolet;">Tel. : </strong> {{vlocataireTel}}</a>
                </div>
                <div class="col-md-4" style="text-align: right;">
                    <img src="{{urlgimg + vlocatairePhoto}}" alt="" width="45px" height="50px">
                </div>
            </div>


            <p-table #dt1 [value]="locataires" dataKey="id" [rows]="12" [showCurrentPageReport]="true"
                [rowsPerPageOptions]="[12,24,48]" [loading]="isLoading" styleClass="p-datatable-gridlines"
                [paginator]="true" currentPageReportTemplate="Affichage de {first} à {last} sur {totalRecords} éléments"
                [globalFilterFields]="['idWave','mois','annee']">
                <ng-template pTemplate="caption">
                    <div class="flex">
                        <span class="p-input-icon-left ml-auto">
                            <i class="pi pi-search"></i>
                            <input pInputText type="text"
                                (input)="dt1.filterGlobal($any($event.target).value, 'contains')"
                                placeholder="Recherche rapide" />
                        </span>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Reference
                                <p-columnFilter type="text" field="idWave" display="menu"></p-columnFilter>
                            </div>
                        </th>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Mois
                                <p-columnFilter type="text" field="mois" display="menu"></p-columnFilter>
                            </div>
                        </th>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Année
                                <p-columnFilter type="text" field="annee" display="menu"></p-columnFilter>
                            </div>
                        </th>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Montant versé
                            </div>
                        </th>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Date du versement
                            </div>
                        </th>
                        <th>
                            <div class="flex justify-content-center align-items-center">
                                Dernière relance le
                            </div>
                        </th>
                        <th>
                            Actions
                        </th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-locataire>
                    <tr>
                        <td>
                            {{locataire.idWave}}
                        </td>
                        <td>
                            <span class="image-text">{{locataire.mois}}</span>
                        </td>
                        <td>
                            <span class="image-text">{{locataire.annee}}</span>
                        </td>
                        <td>
                            <span class="image-text">{{locataire.amount}} </span>
                        </td>
                        <td>
                            {{locataire.when_completed | date: 'MM/dd/yyyy'}}
                        </td>
                        <td>
                            {{locataire.relance | date: 'MM/dd/yyyy'}}
                        </td>
                        <td>

                            <p-badge class=" me-2" title="Envoyer une relance"
                                *ngIf="(!locataire.when_completed && locataire.nummois < numMoisencours && locataire.annee <= numAnneencours ) || 
                               (!locataire.when_completed && locataire.nummois == numMoisencours  && locataire.annee == numAnneencours && numJour > 10 )"
                                (click)="relance(locataire.mois, locataire.annee, locataire.locataire)"
                                [value]="'En retard'" severity="danger"></p-badge>


                            <p-badge class="me-2 " title="Envoyer une Alert à l'Hussier"
                                *ngIf="(!locataire.when_completed && locataire.nummois < numMoisencours && locataire.annee <= numAnneencours ) || 
                               (!locataire.when_completed && locataire.nummois == numMoisencours  && locataire.annee == numAnneencours && numJour > 10 )"
                                (click)="relance(locataire.mois, locataire.annee, locataire.locataire)"
                                [value]="'Alert Hussier'" severity="danger"></p-badge>


                            <a class="btn btn-secondary " *ngIf="locataire.when_completed">
                                <p-badge *ngIf="locataire.amount == vproprietePrix" [value]="'Reglé'" severity="success"></p-badge>
                                <p-badge *ngIf="locataire.amount < vproprietePrix" [value]="'Partiellement'" severity="success"></p-badge>
                            </a>

                            <a class="btn btn-secondary  me-2" title="Non Echu"
                                *ngIf="!locataire.when_completed && locataire.nummois > numMoisencours ">
                                <p-badge [value]="'Non Echu'" severity="info"></p-badge>
                            </a>

                            <a class="btn btn-secondary  me-2" title="En cours"
                                *ngIf="!locataire.when_completed && locataire.nummois == numMoisencours  && locataire.annee == numAnneencours && numJour <= 10 "
                                (click)="relance(locataire.mois, locataire.annee, locataire.locataire)">
                                <p-badge [value]="'Encours'" severity="warning"></p-badge>
                            </a>



                        </td>


                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7">Aucun enregistrement </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Fermer" icon="pi pi-times" class="p-button-text" (click)="fermer()"></button>
    </ng-template>

</p-dialog>

<!--------------------------------------------------------------------------->
<p-dialog [(visible)]="modifLocataire" [style]="{width: '80%'}"
    header="Modification infos. Locataire :  {{vlocataireRef}} " [modal]="true" styleClass="p-fluid"
    [maximizable]="true" [baseZIndex]="10000" [draggable]="false" [resizable]="false">


    <ng-template pTemplate="content">

        <div class="card">
            <div class="card-header text-uppercase text-primary fw-bold" style="text-align: center">
                Formulaire de modification d'un locataire


                <img *ngIf="lienPhotoretour != urlgimg " src="{{ lienPhotoretour }}" alt="" width="100" height="100"
                    class="rounded-circle ml-5" />

                <img *ngIf="lienPhotoretour == urlgimg " src="{{ urlphotoDefault }}" alt="" width="100" height="100"
                    class="rounded-circle ml-5" />

            </div>

            <div class="card-body">
                <form class="row" [formGroup]="formGroup">
                    <input type="text" formControlName="locataireId" placeholder="locataireId" hidden />
                    <input type="text" formControlName="bailleurId" placeholder="bailleurId" hidden />
                    <input type="text" formControlName="locataireRef" placeholder="locataireRef" hidden />

                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" formControlName="proprieteCode" readonly />

                    </div>
                    <div class="review-form col-lg-4 col-md-5 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Localisation" readonly
                            [(ngModel)]="localisation" formControlName="localisation">
                    </div>
                    <div class="review-form col-lg-3 col-md-2 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Type" readonly [(ngModel)]="type"
                            formControlName="type">
                    </div>
                    <div class="review-form col-lg-2 col-md-2 col-sm-12 col-12">
                        <input type="number" class="form-control" readonly [(ngModel)]="prix" formControlName="prix">
                    </div>

                    <div class="hcenter" *ngIf="qrcode!=''">
                        <!--img src="{{urlimg}}" width="100px"-->
                        <div class="qrcodeImage" style="text-align: center;">
                            <qrcode #parent [qrdata]="qrcode" [allowEmptyString]='false' [elementType]="'img'"
                                [errorCorrectionLevel]="'M'" [width]="100" [margin]="4" [scale]="1"
                                (qrCodeURL)="onChangeURL($event, parent)"></qrcode>
                        </div>
                    </div>


                    <hr style="margin-top: 0px;" />
                    <div class="review-form col-lg-6 col-md-6 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Nom & Prénom(s)"
                            formControlName="locataireNom">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="date" class="form-control" placeholder="Date de naissance"
                            formControlName="locataireDatenais">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <select class="form-select-lg form-select rounded-0" formControlName="locataireNationalite">
                            <option value="">Nationalité</option>
                            <option value="Ivoirienne">Ivoirienne</option>
                            <option value="Camerounaise">Camerounaise</option>
                        </select>
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Téléphone" formControlName="locataireTel">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Email" formControlName="locataireEmail">
                    </div>

                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <select class="form-select-lg form-select rounded-0" formControlName="locataireSituationmatri">
                            <option value="">S. Matrimoniale</option>
                            <option value="Célibataire">Célibataire</option>
                            <option value="Mariée">Mariée</option>
                            <option value="Veuve">Veuve</option>
                            <option value="Divorcée">Divorcée</option>
                        </select>
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="number" class="form-control" placeholder="Nombre de personnes à charge"
                            formControlName="locataireNbrecharge">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <select class="form-select-lg form-select rounded-0" formControlName="locataireTypecontrat">
                            <option value="">Type de contrat</option>
                            <option value="Indépendant">Indépendant</option>
                            <option value="CDD">CDD</option>
                            <option value="CDI">CDI</option>
                        </select>
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Profession"
                            formControlName="locataireProfession">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Salaire mensuel net"
                            formControlName="locataireSalaire">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Email du gestionnaire"
                            formControlName="locataireBanque">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Nom de votre garant"
                            formControlName="locataireNomgarant">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="text" class="form-control" placeholder="Téléphone de votre garant"
                            formControlName="locataireTelgarant">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="email" class="form-control" placeholder="Email de votre garant"
                            formControlName="locataireEmailgarant">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <input type="number" class="form-control" placeholder="Caution "
                            formControlName="locataireCaution">
                    </div>
                    <div class="review-form col-lg-3 col-md-3 col-sm-12 col-12">
                        <div class="col-6 input-group mb-3">
                            <div class="input-group-text">
                                <label style="cursor: pointer" for="file"><i class="ti ti-upload"></i> Photo
                                    <span class="text-danger">*</span></label>
                                <input type="file" accept="image/png, image/jpeg" id="file"
                                    class="form-control form-control-lg rounded-0 d-none"
                                    (change)="onFileChange($event)" />
                            </div>
                            <input type="text" class="form-control" readonly [value]="previewImage ? previewImage : ''"
                                placeholder="Aucun fichier sélectionné" />

                        </div>
                    </div>
                    <div class="review-form col-12 d-flex align-items-center justify-content-center">
                        <button class="btn-secondary me-3" (click)="fermer()">
                            Annuler
                        </button>
                        <button type="button" class="btn-primary" (click)="submitModifLocataire(formGroup.value)"
                            [disabled]="formGroup.invalid">
                            Enregistrer
                        </button>
                    </div>
                </form>
            </div>
        </div>


    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton pRipple label="Fermer" icon="pi pi-times" class="p-button-text" (click)="fermer()"></button>
    </ng-template>

</p-dialog>